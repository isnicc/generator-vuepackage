'use strict';

function isType(e,t){return(void 0===e?"undefined":_typeof(e))===t}function isNumber(e){return isType(e,"number")}function rnd(){return 65535*Math.random()}function rndSeed(){return Math.ceil(rnd()).toString(16)}function genRequestId(){return _.now().toString(16)+"-"+rndSeed()+"-"+rndSeed()}function setCache(e,t){wx.setStorageSync(storagePrefix+e,t);}function getCache(e){return wx.getStorageSync(storagePrefix+e)}function removeCache(e){wx.removeStorageSync(storagePrefix+e);}function LXCUID(e){function t(e,t){var r,n=0;for(r=0;r<t.length;r++)n|=u[r]<<8*r;return e^n}var r=getCache("lxcuid");if(r)return r;var n,a,o=function(){for(var e=1*new Date,t=0;e===1*new Date&&t<200;)t++;return e.toString(16)+t.toString(16)},i=+(Math.random()+"").slice(2),s=e.ua||"",u=[],c=0;for(n=0;n<s.length;n++)a=s.charCodeAt(n), u.unshift(255&a), u.length>=4&&(c=t(c,u), u=[]);u.length>0&&(c=t(c,u)), s=c;var d=0;e.sc&&(d=e.sc.split("*"), d=+d[0]*+d[1]);var _=[o(),i,s,d,o()].map(function(e){return e.toString(16)}).join("-");return setCache("lxcuid",_), _}function InitEnv(){return new Promise(function(e){var t=wx.getSystemInfoSync(),r="MicroMessengerWXA ("+t.model+"; "+t.system+"; "+t.pixelRatio+"dpr; language/"+t.language+") "+t.platform+"/"+t.version+" NetType/";env$1.ct=t.platform, env$1.sc=t.screenWidth+"*"+t.screenHeight, env$1.ua=r;var n=getCache("wxid"),a=getCache("wxunionid");n&&(env$1.wxid=n), a&&(env$1.wxunionid=a), wx.getNetworkType({success:function(t){env$1.net=t.networkType.toUpperCase(), env$1.ua=env$1.ua.replace(/(NetType\/).*/,"$1"+t.networkType.toUpperCase()), e(env$1);},fail:function(){e(env$1);}});})}function setEnv(e,t){"category"===e&&(t="data_sdk_"+t), "wxid"!==e&&"wxunionid"!==e||setCache(e,t), env$1[e]=t;}function getEnv(e){return e?e&&env$1[e]:env$1}function MSID(){var e=[],t=_.now();return e.push(t.toString(16)), e.push(rndSeed()), e.push(rndSeed()), e.push(rndSeed()), e.join("-")}function retry(e,t){MAX_RETRY>=retryTime&&(retryTime++, setTimeout(function(){postData(e,undef,t);},retryInterval(retryTime)));}function dropData(e){var t=e.length;return t>MAX_REPORT_COUNT&&e.splice(0,t-MAX_REPORT_COUNT), e}function sendData(e,t,r){var n=getEnv(),a=[Object.assign({evs:t},n)];wx.request({method:"POST",url:e,data:a,success:function(t){400>t.statusCode?(removeCache(sendCacheKey), retryTime=0, r&&r(t)):retry(e,r);},fail:function(){retry(e,r);},complete:function(e){pending=!1;}});}function postData(e,t,r){var n=getCache(cacheKey);n||(n=[]), (t||n.length)&&(t&&(retryTime=0), pending?(t&&(n.push(t), setCache(cacheKey,dropData(n))), retry(e,r)):(pending=!0, t&&n.push(t), removeCache(cacheKey), setCache(sendCacheKey,n), sendData(e,n,r)));}function Tracker(){var e=this;InitEnv().then(function(e){}), e._opts={}, requestId=genRequestId();}function WebEvsWrapper(e,t,r,n){var a={nm:e,tm:_.now(),nt:NT_WECHART,seq:seq++,isauto:ISAUTO_WECHART,req_id:t};if(currentCid)a.val_cid=currentCid;else{var o=getCurrentPages();o&&o.length&&(a.val_cid=o[o.length-1].__route__);}return r&&(a.val_lab=r), valRef&&(a.val_ref=valRef), n&&(a.val_bid=n), refRequestId&&(a.ref_req_id=refRequestId), a}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e}; var undef=void 0; var _={}; var ObjectProto=Object.prototype; var toStr=ObjectProto.toString; var hasOwn=ObjectProto.hasOwnProperty; var storagePrefix="_lx_sdk_";_.isStr=function(e){return e&&isType(e,"string")}, _.isObj=function(e){return e&&"[object Object]"===toStr.call(e)}, _.now=function(){return new Date-0}, _.isArray=Array.isArray||function(e){return"[object Array]"===toStr.call(e)}, _.isArrayLike=function(e){if(!e)return!1;var t=e.length;return!!_.isArray(e)||!!(e&&isNumber(t)&&t>=0)&&(!_.isObj(e)||(!(t>1)||t-1 in e))}, _.each=function(e,t,r){if(e){var n,a,o;if(_.isArrayLike(e))for(a=0, o=e.length;a<o&&!1!==t.call(r,e[a],a,e);a++);else for(n in e)if(hasOwn.call(e,n)&&!1===t.call(r,e[n],n,e))break}}, _.extend=function e(t,r,n){var a,o=!0===t;return o||(n=r, r=t), r&&_.isObj(r)||(r={}), n&&_.isObj(n)||(n={}), _.each(n,function(t,i){o&&_.isObj(n[i])?(a=r[i]={}, e(o,a,n[i])):r[i]=n[i];}), r};var env$1={sdk_ver:"1.2.1",ch:"weixin",lch:"wx"};env$1.lxcuid=LXCUID(env$1);var MAX_RETRY=3; var MAX_REPORT_COUNT=30; var pending=!1; var cacheKey="lx_cache_data"; var sendCacheKey="lx_send_cache_data"; var retryTime=0; var retryInterval=function(e){var t=Math;return t.ceil(t.min(1e3*(.5+t.random())*t.pow(2,e),15e3))}; var NM_APP_START="AS"; var NM_APP_QUIT="AQ"; var NM_PAGE_VIEW="PV"; var NM_PAGE_DISAPPEAR="PD"; var NM_MODULE_CLICK="MC"; var NM_MODULE_SYSTEM_CHECK="SC"; var NM_MODULE_VIEW="MV"; var NM_MODULE_EDITOR="ME"; var NM_BIZ_ORDER="BO"; var NM_BIZ_PAY="BP"; var NT_WECHART=3; var ISAUTO_WECHART=7; var lastEventTimestamp=Date.now(); var seq=1; var startTime=Date.now(); var currentCid=undef; var valRef=undef; var requestId; var refRequestId; var asRequestId; var TrackerProto=Tracker.prototype;TrackerProto.init=function(e,t){var r=this,n=r._opts;n.reportUrl=e;var a=t.appnm,o=t.category;o||(t.category=a), t.appnm=a, _.each(t||{},function(e,t){if(!_.isStr(t)||undef===e)return n[t];r.set(t,e), n[t]=e;});}, TrackerProto.setUTM=function(e){if(e){var t=this,r=e||{},n=r.query||{},a=r.referrerInfo||{},o=["utm_source","utm_medium","utm_term","utm_content","utm_campaign"],i={};if("clear"===r)return void delete env.utm;if(n&&_.each(o,function(e){_.isStr(n[e])&&(i[e]=n[e]);}), a.extraData){var s=a.extraData;if(_.isStr(s))try{s=JSON.parse(s);}catch(e){s={};}_.each(o,function(e){_.isStr(s[e])&&(i[e]=s[e]);});}_.each(o,function(e){_.isStr(r[e])&&(i[e]=r[e]);}), i.utm_source||1037!=r.scene&&1038!=r.scene||r.referrerInfo&&r.referrerInfo.appId&&(i.utm_source=r.referrerInfo.appId, i.utm_medium="otherApp"), Object.keys(i).length>0&&t.set("utm",i);}}, TrackerProto.set=function(e,t){setEnv(e,t);}, TrackerProto.get=function(e){return getEnv(e)}, TrackerProto.start=function(e){var t=_.isObj(e)?e:undef;startTime=Date.now(), asRequestId=genRequestId(), requestId=null, seq=1, setEnv("msid",MSID());var r=WebEvsWrapper(NM_APP_START,asRequestId,t);r.isauto=6, this.send(r);}, TrackerProto.quit=function(e){var t=_.isObj(e)?e:{},r=Date.now()-startTime;t=_.extend({duration:""+r},t);var n=WebEvsWrapper(NM_APP_QUIT,asRequestId,t);n.isauto=6, this.send(n);}, TrackerProto.pageView=function(e,t){(!requestId||currentCid&&currentCid!==e)&&(valRef=currentCid, refRequestId=requestId, requestId=genRequestId()), currentCid=e;var r=WebEvsWrapper(NM_PAGE_VIEW,requestId,t);this.send(r);}, TrackerProto.pageDisappear=function(e){var t=WebEvsWrapper(NM_PAGE_DISAPPEAR,requestId,e);this.send(t);}, TrackerProto.moduleView=function(e,t){var r=WebEvsWrapper(NM_MODULE_VIEW,requestId,t,e);this.send(r);}, TrackerProto.systemCheck=function(e,t){var r=WebEvsWrapper(NM_MODULE_SYSTEM_CHECK,requestId,t,e);this.send(r);}, TrackerProto.moduleClick=function(e,t){var r=WebEvsWrapper(NM_MODULE_CLICK,requestId,t,e);this.send(r);}, TrackerProto.moduleEdit=function(e,t){var r=WebEvsWrapper(NM_MODULE_EDITOR,requestId,t,e);this.send(r);}, TrackerProto.order=function(e,t,r){r=_.extend(r||{},{order_id:t});var n=WebEvsWrapper(NM_BIZ_ORDER,requestId,r,e);this.send(n);}, TrackerProto.pay=function(e,t,r){r=_.extend(r||{},{order_id:t});var n=WebEvsWrapper(NM_BIZ_PAY,requestId,r,e);this.send(n);}, TrackerProto.send=function(e,t){18e5<Date.now()-lastEventTimestamp&&setEnv("msid",MSID()), lastEventTimestamp=Date.now();var r=this,n=r._opts.reportUrl;n&&postData(n,e,function(e){t&&t(e);});};var index=new Tracker;var lib=index;

module.exports = lib;
